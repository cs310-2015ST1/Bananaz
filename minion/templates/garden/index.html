<!doctype html>
<html>
<head>
{% load staticfiles %}
<link rel="stylesheet" type="text/css" href="../../static/stylesheet.css">

<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<script src="https://maps.google.com/maps/api/js?sensor=false"></script>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script>
	var map,marker,gardenByID= {};
    gardenByID = {};
    var route = [];
	var allmarkers = new Array();

    var all_icons = {
        'any':'http://img3.wikia.nocookie.net/__cb20100619222000/frontierville/images/f/f3/Apple_Tree_Fruit-icon.png',
        'apple':'http://1.bp.blogspot.com/-o1EwYtA5w7A/VaQ57OJNyVI/AAAAAAAACHs/GXX2-PGuiqM/s320/apple.jpg',
        'apricot':'http://1.bp.blogspot.com/-2NFvFAqI9bw/VaQ59UP5-6I/AAAAAAAACH4/fPBRr7JOF5w/s320/apricot.jpg',
        'blueberry':'http://2.bp.blogspot.com/-ti7Wwragl1M/VaQ59azieVI/AAAAAAAACH0/C4RoIMfzULw/s320/blueberry.jpg',
        'cherry':'http://3.bp.blogspot.com/-4XUkrRAcLr4/VaQ59R3X83I/AAAAAAAACH8/jhvmsecEbYc/s320/cherry.jpg',
        'fig':'http://1.bp.blogspot.com/-L4TTbCHDri8/VaQ596aWAGI/AAAAAAAACII/AKpOvroRuxo/s320/fig.jpg',
        'grape':'http://4.bp.blogspot.com/-ooaBXqFO4HI/VaQ5-KOnwuI/AAAAAAAACJM/HQ2p1m_koFc/s320/grape.jpg',
        'hazelnut':'http://1.bp.blogspot.com/-sHQ559cBkLo/VaQ5-Mq3akI/AAAAAAAACIE/s2HnzzAhvn8/s320/hazelnut.jpg',
        'lemon':'http://1.bp.blogspot.com/-XvB052jp-JQ/VaQ5-tWtHiI/AAAAAAAACIU/83vtuV3Cci0/s320/lemon.jpg',
        'peach':'http://1.bp.blogspot.com/-0T8Y3x2D6LY/VaQ5-_lfSsI/AAAAAAAACIY/zNaurxjKzqU/s320/peach.jpg',
        'pear':'http://2.bp.blogspot.com/-h9UBynl1Xrc/VaQ5_ToqwoI/AAAAAAAACIg/vMzUiF4iz1Q/s320/pear.jpg',
        'persimmon':'http://3.bp.blogspot.com/-8BhnvGLjvWs/VaQ5_i2c0RI/AAAAAAAACIk/w-ZZUEADX80/s320/persimmon.jpg',
        'plum':'http://1.bp.blogspot.com/-356efJBRS7Q/VaQ6ALFlv-I/AAAAAAAACI4/IO_cbPHcFEU/s320/plum.jpg',
        'quince':'http://4.bp.blogspot.com/-oSHnaShRdhs/VaQ6AVCKxyI/AAAAAAAACI0/IqU-idLNAUA/s320/quince.jpg',
        'raspberry':'http://3.bp.blogspot.com/-y2GjJJGUtpo/VaQ6BMTKCvI/AAAAAAAACJA/f2vrg0xu-9o/s320/raspberry.jpg',
        'walnut':'http://1.bp.blogspot.com/-zY9kXlsBAZ8/VaQ6BzqvpiI/AAAAAAAACJc/uMsrkvvf8fw/s320/walnut.jpg'
    };

    // for Getting Directions
    var directionsService = new google.maps.DirectionsService();
    var directionsDisplay = new google.maps.DirectionsRenderer();
    var userLatLng = new google.maps.LatLng(0,0);

	function initialize(){
		map = new google.maps.Map(document.getElementById('map'),{
				zoom: 12,
				center: new google.maps.LatLng(49.261,-123.1139),
				mapTypeId: google.maps.MapTypeId.TERRAIN
				});

        // for Getting Directions
        directionsDisplay.setMap(map);

        navigator.geolocation.getCurrentPosition(function (position) {
            userLatLng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
        }, function () {
        });


	}
var i = 0;

{% for g in gardens %}
    gardenByID[{{g.id}}] = {
        name: "{{g.name}}",
        lat: {{g.latitude}},
        lng: {{g.longitude}},
        foodTrees: []
    };
{% endfor %}
{% for g in gardens %}
    {% for tree in g.foodtree_set.all %}
        gardenByID[{{ g.id }}].foodTrees.push({
            food_type: "{{ tree.food_type }}",
            amount : {{ tree.amount }}
        });
    {%  endfor %}
{%  endfor %}


	$(document).ready(function () {

    function activateGardens() {

        var icon_url = all_icons['{{ name_of_fruit }}'];

        var imagemedium = {
                url: icon_url,
                size: new google.maps.Size(71,71),
                origin : new google.maps.Point(0,0),
                anchor: new google.maps.Point(17, 34),
                scaledSize: new google.maps.Size(45,45)
            };
        // Add Garden click handler
        $('.g').each(function () {
            $(this).click(function(e) {

                var garden = gardenByID[this.id];

                // prevent button click to do the same thing as a table row click
                if($(e.target).is('button')){

                    // twitter button click function.
                    if (e.target.id === 'add_tweet'){
                        e.preventDefault();
                        window.open('form/');
                    }
                    else if (e.target.id === 'display_route') {
                        e.preventDefault();
                        displayRoute(garden.lat, garden.lng);
                        $('#directionsstatus').html('you are viewing the route from your current location to ' + garden.name);
                    }

                    return;}

                var center = new google.maps.LatLng(garden.lat, garden.lng);
				clearOverlays();

                if (marker) marker.setMap();
                marker = new google.maps.Marker({
                    map: map,
                    position: center,
                    icon: imagemedium
                });
                map.panTo(center);
                $('#directionsstatus').html('you are viewing the location of ' + garden.name);


            }).hover(
                function () {this.className = this.className.replace('OFF', 'ON');},
                function () {this.className = this.className.replace('ON', 'OFF');}
            );
        });

    }

	function clearOverlays(){
		for (var i = 0; i < allmarkers.length; i++ ) {
				allmarkers[i].setMap(null);
			}
		allmarkers.length = 0;

        directionsDisplay.set('directions', null);

	}


	function setPoint(){
        var j = 0;

        var icon_url = all_icons['{{ name_of_fruit }}'];

        var imagesmall = {
                url: icon_url,
                size: new google.maps.Size(71,71),
                origin : new google.maps.Point(0,0),
                anchor: new google.maps.Point(17, 34),
                scaledSize: new google.maps.Size(25,25)
            };

        var imagemedium = {
                url: icon_url,
                size: new google.maps.Size(71,71),
                origin : new google.maps.Point(0,0),
                anchor: new google.maps.Point(17, 34),
                scaledSize: new google.maps.Size(45,45)
            };
        var imagebig = {
                url: icon_url,
                size: new google.maps.Size(71,71),
                origin : new google.maps.Point(0,0),
                anchor: new google.maps.Point(17, 34),
                scaledSize: new google.maps.Size(65,65)
            };

		$('.g').each(function(){

            var garden = gardenByID[this.id];

            var foodtrees = gardenByID[this.id].foodTrees;

            var COUNT = 0;

            for (var i=0; i<(foodtrees.length); i++){
                if (('{{ name_of_fruit }}' != 'any') && ('{{ name_of_fruit }}' == foodtrees[i].food_type)){
                    COUNT = parseInt(foodtrees[i].amount);
                    break;
                }
                COUNT += parseInt(foodtrees[i].amount);
            }


            $('#directionsstatus').append(COUNT);

            if (COUNT  <= 1) {
                allmarkers[j] = new google.maps.Marker({
                    position: new google.maps.LatLng(garden.lat, garden.lng),
                    title: garden.name,
                    icon: imagesmall
                });
            }
            else if (COUNT>1 && COUNT <4 ){
                allmarkers[j] = new google.maps.Marker({
				position: new google.maps.LatLng(garden.lat, garden.lng),
				title: garden.name,
                icon: imagemedium
            });
            }

            else if (COUNT>=4){
                allmarkers[j] = new google.maps.Marker({
				position: new google.maps.LatLng(garden.lat, garden.lng),
				title: garden.name,
                icon: imagebig
            });
            }
                else{
                allmarkers[j] = new google.maps.Marker({
				position: new google.maps.LatLng(garden.lat, garden.lng),
				title: garden.name
			});
            }

			j++;
		});
		for(var i=0;i<j;i++){
			allmarkers[i].setMap(map);
		}

        // JQuery code for Getting Directions.
        google.maps.event.addListener(map, 'click', function(e) {

          });

        google.maps.event.addListener(marker, 'mouseover', function() {
            infowindow.open(map, this);
        });

        google.maps.event.addListener(marker, 'mouseout', function() {
            infowindow.close();
        });
	}

	
    google.maps.event.addDomListener(window, 'load', setPoint);
    activateGardens();

    // JQuery code for Admin View All Users.
    $('#display_users').click(function(){

         $.get('update_users/', function(data){
                   $('#all_users').html(data);
               });
    });
	
    // for Getting Directions
    function displayRoute(lati, long) {

        var center = new google.maps.LatLng(lati, long);
        clearOverlays();
        if (marker) marker.setMap();

        map.panTo(center);

        calcRoute(userLatLng, center);
    }


    function calcRoute(start, end) {

      var request = {
        origin:start,
        destination:end,
        travelMode: google.maps.TravelMode.DRIVING
      };
      route = directionsService.route(request, function(result, status) {
        if (status == google.maps.DirectionsStatus.OK) {
          directionsDisplay.setDirections(result);
        }
        else{
            alert( 'user location disabled. please enable sharing your location' );
        }
      });
    }

});



</script>
{% include 'garden/save_garden.html' %}
<style>

</style>


</head>
<body onload='initialize()'>

	{% include 'garden/home.html' %}
    <div class="box-centerside-left-panel">
      <div class="panel-body">
	{% include 'garden/login.html' %}


    <a href="../">Home</a>

    <br>

    {% if user and not user.is_anonymous and user.is_superuser %}
        <button id ="display_users" class="btn btn-mini btn-primary" type="button">All Users</button>
    {% endif %}
    <div id=user_button></div>
    <div id="all_users"></div>

      </div>
    </div>

    <div class="box-centerside-right-panel">
      <div class="panel-body">
          {% include 'garden/search_criteria.html' %}


    {% if name_of_garden %}
        You are displaying gardens containing keyword: {{ name_of_garden }}
    {% endif %}
    <br>
    {% if name_of_fruit %}
        You are displaying gardens containing fruit type: {{ name_of_fruit }}
    {% endif %}

      </div>
    </div>

    <br>

	<div id=map></div>

    <div id=directionsstatus></div>


    <table>
    <tr>
        <th>Garden</th>

        <th>Latitude</th>

        <th>Longitude</th>

        <th>Fruits in Garden</th>
    </tr>
    {% for g in gardens %}
    <tr id={{g.id}} class='g linkOFF'>
        <td>{{ g.name }}</td>

        <td>{{ g.latitude }}</td>

        <td>{{ g.longitude }}</td>
        <td>
            <ul class="comma-separated">
                {% for tree in g.foodtree_set.all %}
                    <li>{{ tree.food_type }} ({{ tree.amount }})</li>
                {% endfor %}
            </ul>
        </td>

        <td><button id ="display_route" class="btn btn-mini btn-primary" type="button" value="{{ g.latitude }}" name="{{ g.longitude }}">Display Route</button></td>
		{% if user and not user.is_anonymous and not user.is_superuser %}
            <td><button id ="add_tweet" class="btn btn-mini btn-primary" type="button">Tweet</button></td>
            <td><button class="save_garden">Save Garden</button></td>
        {% endif %}

    </tr>
    {% endfor %}
	</table>

<br>

</body>


</html>
