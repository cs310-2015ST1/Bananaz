<!doctype html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<script src="https://maps.google.com/maps/api/js?sensor=false"></script>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script>
	var map,marker,gardenByID,userByID = {};
	var allmarkers = new Array();

	function initialize(){
		map = new google.maps.Map(document.getElementById('map'),{
				zoom: 12,
				center: new google.maps.LatLng(49.261,-123.1139),
				mapTypeId: google.maps.MapTypeId.TERRAIN
				});
	}
	{% for g in gardens %}
	gardenByID[{{g.id}}] = {
		name: "{{g.name}}",
		lat: {{g.latitude}},
		lng: {{g.longitude}}
	};
	{% endfor %}


	$(document).ready(function () {
    function activateGardens() {
        // Add Garden click handler
        $('.g').each(function () {
            $(this).click(function() {
                var garden = gardenByID[this.id];
                var center = new google.maps.LatLng(garden.lat, garden.lng);
				clearOverlays();
                if (marker) marker.setMap();
                marker = new google.maps.Marker({map: map, position: center});
                map.panTo(center);
            }).hover(
                function () {this.className = this.className.replace('OFF', 'ON');},
                function () {this.className = this.className.replace('ON', 'OFF');}
            );
        });

    }

	function clearOverlays(){
		for (var i = 0; i < allmarkers.length; i++ ) {
				allmarkers[i].setMap(null);
			}
		allmarkers.length = 0;
	}
	
	function setPoint(){
		var j = 0;
		$('.g').each(function(){
			var garden = gardenByID[this.id];
			allmarkers[j] = new google.maps.Marker({
				position: new google.maps.LatLng(garden.lat, garden.lng),
				title: garden.name,
			});
			j++;
		});
		for(var i=0;i<j;i++){
			allmarkers[i].setMap(map);
		}
	}

	
google.maps.event.addDomListener(window, 'load', setPoint);
    activateGardens();
});



</script>
<style>
	body {font-family: sans-serif}
	#map {width: 1000px; height: 500px}
	#gardens {overflow: auto; width: 500px; height: 100px}
    .linkOFF {color: darkblue}
    .linkON {color: white; background-color: darkblue;cursor:pointer}
    ul.comma-separated {list-style: none; display: inline; padding:0; margin:0}
    ul.comma-separated li {display:inline}
    ul.comma-separated li:after {content: ","}
    ul.comma-separated li:last-child:after {content: ""}
</style>
</head>
<body onload='initialize()'>

	{% include 'garden/home.html' %}
	{% include 'garden/login.html' %}


	<div id=map></div>
	
    <table>
    <tr>
        <th>Garden</th>

        <th>Latitude</th>

        <th>Longitude</th>

        <th>Fruits in Garden</th>
    </tr>
    {% for g in gardens %}
    <tr id={{g.id}} class='g linkOFF'>
        <td>{{ g.name }}</td>

        <td>{{ g.latitude }}</td>

        <td>{{ g.longitude }}</td>
        <td>
            <ul class="comma-separated">
                {% for tree in g.foodtree_set.all %}
                    <li>{{ tree.food_type }} ({{ tree.amount }})</li>
                {% endfor %}
            </ul>
        </td>

    </tr>
    {% endfor %}
	</table>
    {% include 'garden/search_criteria.html' %}

    {% include 'garden/update_users_button.html' %}
</body>





<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
{% load staticfiles %}
{% comment %}<script src="{% static "admin/update_users.js" %}"></script>{% endcomment %}

<script>
$("#updateuser-form").submit(function(event) {
    event.preventDefault();
    clickedUpdate();
});

function setLog(r) {
    $("#log").html(r);
}

function clickedUpdate() {
    setLog("Please wait...");
    $("#update-button").attr("disabled", "disabled");
    $.ajax({
        url: getImportUrL(),
        type: "POST",
        data: {
            csrfmiddlewaretoken: getCsrfToken()
        },
        //dataType: 'json',
        success: function() {
            setLog("Success!");
            $("#update-button").removeAttr("disabled");

            var str = '';
            for (var i in users) {
                //$('#print_users').append(i. + '<br/>');
                str.append("print_users!");


        }
            setLog(str);

        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.log(jqXHR);
            console.log(textStatus);
            console.log(errorThrown);

            setLog("Error! " + errorThrown);
            $("#update-button").removeAttr("disabled");
        }
    });
    return false;
}



    function getCsrfToken() {
        return '{{ csrf_token }}';
    }
    function getImportUrL() {
        return '{% url "ajax_update_users" %}';
    }
</script>

</html>
