<!doctype html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<script src="https://maps.google.com/maps/api/js?sensor=false"></script>
{#<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>#}
{#<script type="text/javascript"#}
{#      src="https://maps.googleapis.com/maps/api/js?key=API_KEY">#}
{#    </script>#}
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script>
	var map,marker,gardenByID = {};
    var route = [];
	var allmarkers = new Array();

    // for Getting Directions
    var placedmarkers = new Array();
    var directionsService = new google.maps.DirectionsService();
    var directionsDisplay = new google.maps.DirectionsRenderer();
    var userLatLng = new google.maps.LatLng(0,0);

	function initialize(){
		map = new google.maps.Map(document.getElementById('map'),{
				zoom: 12,
				center: new google.maps.LatLng(49.261,-123.1139),
				mapTypeId: google.maps.MapTypeId.TERRAIN
				});

        // for Getting Directions
        directionsDisplay.setMap(map);

	}
	{% for g in gardens %}
	gardenByID[{{g.id}}] = {
		name: "{{g.name}}",
		lat: {{g.latitude}},
		lng: {{g.longitude}}
	};
	{% endfor %}


	$(document).ready(function () {
    function activateGardens() {
        // Add Garden click handler
        $('.g').each(function () {
            $(this).click(function(e) {
                //alert( this.id );
                var garden = gardenByID[this.id];

                if($(e.target).is('button')){
                    e.preventDefault();
                    displayRoute(garden.lat, garden.lng);
                    return;}
{#                if ($this.is('#display_route')) {#}
{#                    displayRoute(garden.lat, garden.lng);#}
{#                    return;#}
{#                }#}


{#                if ( $( e.currentTarget ).is( ":button" ) ) {#}
{#                    return;#}
{#                }#}

{#                if($(this).is('button')){#}
{#                    return;#}
{#                }#}

                var center = new google.maps.LatLng(garden.lat, garden.lng);
				clearOverlays();



                if (marker) marker.setMap();
                //allmarkers[0] = marker;
                marker = new google.maps.Marker({map: map, position: center});
                map.panTo(center);

{#                // for Getting Directions#}
{#                var latLng = new google.maps.LatLng(49.26061, -123.24599); //Mock user location#}
{#                setMarker(latLng, map);#}
{#                calcRoute(latLng, center)#}

            }).hover(
                function () {this.className = this.className.replace('OFF', 'ON');},
                function () {this.className = this.className.replace('ON', 'OFF');}
            );
        });

    }

	function clearOverlays(){
		for (var i = 0; i < allmarkers.length; i++ ) {
				allmarkers[i].setMap(null);
			}
		allmarkers.length = 0;

        // for Getting Directions
        for (var k = 0; k < placedmarkers.length; k++ ) {
				placedmarkers[k].setMap(null);
			}
        placedmarkers.length = 0;

        directionsDisplay.set('directions', null);
	}
	
	function setPoint(){
		var j = 0;
		$('.g').each(function(){
			var garden = gardenByID[this.id];
			allmarkers[j] = new google.maps.Marker({
				position: new google.maps.LatLng(garden.lat, garden.lng),
				title: garden.name,
			});
			j++;
		});
		for(var i=0;i<j;i++){
			allmarkers[i].setMap(map);
		}

        // JQuery code for Getting Directions.
        google.maps.event.addListener(map, 'click', function(e) {


            //setMarker(e.latLng, map);

          });

	}

	
google.maps.event.addDomListener(window, 'load', setPoint);
    activateGardens();

    // JQuery code for Admin View All Users.

    $('#display_users').click(function(){

         $.get('update_users/', function(data){
                   $('#all_users').html(data);

               });
    });
	
	$('#add_tweet').click(function(){
		window.open('form/');
	
	});

    function displayRoute(lati, long) {
{#    $('#display_route').click(function(){#}

        {#        var lati = $(this).attr("value");#}
        {#        var long = $(this).attr("name");#}
        {##}
        {#        lati = parseFloat (lati);#}
        {#        long = parseFloat (long);#}
        {#        $('#directionsstatus').html(lati+' '+long);#}

        var center = new google.maps.LatLng(lati, long);
        clearOverlays();



        //if (marker) marker.setMap();
        //allmarkers[0] = marker;
        //marker = new google.maps.Marker({map: map, position: center});
        map.panTo(center);

        // for Getting Directions

        //var latLng = new google.maps.LatLng(49.26061, -123.24599); //Mock user location

        navigator.geolocation.getCurrentPosition(function (position) {
            userLatLng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
        }, function () {
        });

        //setMarker(userLatLng, map);
        calcRoute(userLatLng, center);

        //userLatLng = new google.maps.LatLng(0,0);
    }
{#    });#}


    // code for Getting Directions
    function setMarker(position, map) {

        // setMarker only works if only one garden's marker is on the map
{#        if (allmarkers.length != 1){#}
{#            return;#}
{#        }#}


{#        if ((placedmarkers.length == 0)) {}#}
            var marker = new google.maps.Marker({
            position: position,
            map: map
          });
            placedmarkers[0]=marker;
            placedmarkers[0].setMap(map);

{% comment %}        else if ((placedmarkers.length == 1)){
            placedmarkers[0].setMap(null);

            var marker = new google.maps.Marker({
            position: position,
            map: map
          });
            placedmarkers[0]=marker;
            placedmarkers[0].setMap(map);
        }{% endcomment %}
{#        $('#numofmarkers').html('allmarkers'+allmarkers.length+'placedmarkers'+placedmarkers.length);#}

    }

    function calcRoute(start, end) {

      var request = {
        origin:start,
        destination:end,
        travelMode: google.maps.TravelMode.DRIVING
      };
      route = directionsService.route(request, function(result, status) {
        if (status == google.maps.DirectionsStatus.OK) {
          route = result;
          directionsDisplay.setDirections(result);

        // http://stackoverflow.com/questions/16180104/get-a-polyline-from-google-maps-directions-v3
{#        var legs = response.routes[0].legs;#}
{#        for (i=0;i<legs.length;i++) {#}
{#          var steps = legs[i].steps;#}
{#          for (j=0;j<steps.length;j++) {#}
{#            var nextSegment = steps[j].path;#}
{#            for (k=0;k<nextSegment.length;k++) {#}
{#              polyline.getPath().push(nextSegment[k]);#}
{#              bounds.extend(nextSegment[k]);#}
{#            }#}
{#          }#}
{#        }#}
{#        polyline.setMap(map);#}
{#        map.fitBounds(bounds);#}

        }
        else{
            $('#directionsstatus').html('user location enabled. please click again');
        }
      });
    }

{#    function getUserLocation() {#}
{##}
{#      if(navigator.geolocation) {#}
{#        navigator.geolocation.getCurrentPosition(function(position) {#}
{#            return (new google.maps.LatLng(position.coords.latitude, position.coords.longitude));#}
{##}
{#        }, function() {#}
{##}
{#        });#}
{#      }#}
{#    }#}

});



</script>
<style>
	body {font-family: sans-serif}
	#map {width: 1000px; height: 500px}
	#gardens {overflow: auto; width: 500px; height: 100px}
    .linkOFF {color: darkblue}
    .linkON {color: white; background-color: darkblue;cursor:pointer}
    ul.comma-separated {list-style: none; display: inline; padding:0; margin:0}
    ul.comma-separated li {display:inline}
    ul.comma-separated li:after {content: ","}
    ul.comma-separated li:last-child:after {content: ""}
</style>
</head>
<body onload='initialize()'>

	{% include 'garden/home.html' %}
	{% include 'garden/login.html' %}

    //Fruit Icon
    {% if name_of_fruit %}
        {{ name_of_fruit }}
    {% endif %}


	<div id=map></div>
	<div id=numofmarkers></div>
    <div id=directionsstatus></div>


    <table>
    <tr>
        <th>Garden</th>

        <th>Latitude</th>

        <th>Longitude</th>

        <th>Fruits in Garden</th>
    </tr>
    {% for g in gardens %}
    <tr id={{g.id}} class='g linkOFF'>
        <td>{{ g.name }}</td>

        <td>{{ g.latitude }}</td>

        <td>{{ g.longitude }}</td>
        <td>
            <ul class="comma-separated">
                {% for tree in g.foodtree_set.all %}
                    <li>{{ tree.food_type }} ({{ tree.amount }})</li>
                {% endfor %}
            </ul>
        </td>

        <td><button id ="display_route" class="btn btn-mini btn-primary" type="button" value="{{ g.latitude }}" name="{{ g.longitude }}">Display Route</button></td>
		<td><button id ="add_tweet" class="btn btn-mini btn-primary" type="button">Tweet</button></td>
		

    </tr>
    {% endfor %}
	</table>
    {% include 'garden/search_criteria.html' %}

ONLY WORKS ON INDEX PAGE
    <br>
    {% if user and not user.is_anonymous and user.is_superuser %}
        <button id ="display_users" class="btn btn-mini btn-primary" type="button">All Users</button>
    {% endif %}
    <div id="all_users"></div>
</body>






</html>
